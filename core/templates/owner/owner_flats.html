{% extends 'owner_base.html' %}

{% block title %}My Flats | Society Management{% endblock %}
{% block page_title %}MY FLATS{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3 mb-md-4 fade-in">
    <div>
        <h4 style="font-weight: 700; margin: 0;">My Properties</h4>
        <div style="color: var(--text-secondary); font-size: 0.9rem;">View and manage your assigned flats</div>
    </div>
</div>

<div class="card fade-in" style="overflow: hidden; border-radius: 12px;">
    <div class="table-responsive">
        <table class="custom-table">
            <thead>
                <tr>
                    <th>Unit Details</th>
                    <th>Society Name</th>
                    <th>Assigned Tenant</th>
                    <th>Location</th>
                    <th class="text-end">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for flat in flats %}
                    {% with active_tenant=flat.active_tenant_list.0 %}
                    <tr style="cursor: pointer;" onclick="openFlatModal('{{ flat.flat_number }}', '{{ flat.society.name }}', '{{ flat.society.address|escapejs }}', '{{ active_tenant.user.get_full_name|default:'' }}', '{{ active_tenant.user.phone|default:'' }}', '{{ active_tenant.user.email|default:'' }}')">
                        <td>
                            <div class="d-flex align-items-center">
                                <div style="width: 40px; height: 40px; background: rgba(0, 212, 255, 0.1); color: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0;">
                                    <i class="fas fa-home"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 700; font-size: 1rem;">{{ flat.flat_number }}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">ID: #{{ flat.id }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span style="font-weight: 500;">{{ flat.society.name }}</span>
                        </td>
                        <td>
                            {% if active_tenant %}
                                <div class="d-flex align-items-center">
                                    <div style="width: 30px; height: 30px; background: rgba(0, 227, 150, 0.1); color: var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; font-size: 0.8rem; flex-shrink: 0;">
                                        {{ active_tenant.user.first_name.0|upper }}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; font-size: 0.9rem;">{{ active_tenant.user.get_full_name }}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Active since {{ active_tenant.start_date|date:"M Y" }}</div>
                                    </div>
                                </div>
                            {% else %}
                                <span style="color: var(--text-secondary); font-style: italic; opacity: 0.7;">
                                    <i class="fas fa-user-slash me-2"></i>Not assigned to any tenant
                                </span>
                            {% endif %}
                        </td>
                        <td style="color: var(--text-secondary);">
                            <i class="fas fa-map-marker-alt me-2 text-danger"></i>{{ flat.society.address|truncatechars:30 }}
                        </td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary" style="border-radius: 6px;">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% endwith %}
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center py-5">
                        <i class="fas fa-building mb-3" style="font-size: 2rem; color: var(--border);"></i>
                        <div style="color: var(--text-secondary);">No flats assigned to your account.</div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="flatDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2 text-info"></i>Property Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3 p-md-4">
                <div class="text-center mb-4">
                    <div style="width: 60px; height: 60px; background: rgba(0, 212, 255, 0.1); color: var(--accent); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 1rem;">
                        <i class="fas fa-building"></i>
                    </div>
                    <h4 id="modalFlatTitle" style="font-weight: 700; margin-bottom: 0.25rem;"></h4>
                    <span class="badge badge-success rounded-pill">YOUR PROPERTY</span>
                </div>

                <div class="row g-3">
                    <div class="col-12">
                        <div class="p-3" style="background: var(--primary); border: 1px solid var(--border); border-radius: 8px;">
                            <div class="detail-label">Society Name</div>
                            <div class="detail-value" id="modalSocietyName"></div>
                            
                            <div class="detail-label mt-3">Full Address</div>
                            <div class="detail-value" id="modalAddress" style="font-weight: 400; line-height: 1.5;"></div>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="p-3" style="background: var(--primary); border: 1px solid var(--border); border-radius: 8px;">
                            <h6 style="color: var(--accent); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                <i class="fas fa-user me-2"></i>Current Tenant Details
                            </h6>
                            
                            <div id="tenantInfoBlock">
                                <div class="row">
                                    <div class="col-12 col-sm-6 mb-2">
                                        <div class="detail-label">Name</div>
                                        <div class="detail-value" id="modalTenantName"></div>
                                    </div>
                                    <div class="col-12 col-sm-6 mb-2">
                                        <div class="detail-label">Phone</div>
                                        <div class="detail-value" id="modalTenantPhone"></div>
                                    </div>
                                    <div class="col-12">
                                        <div class="detail-label">Email</div>
                                        <div class="detail-value" id="modalTenantEmail" style="text-transform: lowercase;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="noTenantBlock" class="text-center py-2" style="display: none;">
                                <span style="color: var(--text-secondary); font-style: italic;">No active tenant assigned.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" style="border-color: var(--border); color: var(--text-secondary);">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function openFlatModal(flatNo, societyName, address, tenantName, tenantPhone, tenantEmail) {
        document.getElementById('modalFlatTitle').textContent = 'Flat ' + flatNo;
        document.getElementById('modalSocietyName').textContent = societyName;
        document.getElementById('modalAddress').textContent = address;
        
        const tenantBlock = document.getElementById('tenantInfoBlock');
        const noTenantBlock = document.getElementById('noTenantBlock');
        
        if (tenantName && tenantName.trim() !== "") {
            tenantBlock.style.display = 'block';
            noTenantBlock.style.display = 'none';
            
            document.getElementById('modalTenantName').textContent = tenantName;
            document.getElementById('modalTenantPhone').textContent = tenantPhone || 'N/A';
            document.getElementById('modalTenantEmail').textContent = tenantEmail;
        } else {
            tenantBlock.style.display = 'none';
            noTenantBlock.style.display = 'block';
        }
        
        var myModal = new bootstrap.Modal(document.getElementById('flatDetailModal'));
        myModal.show();
    }
</script>
{% endblock %}